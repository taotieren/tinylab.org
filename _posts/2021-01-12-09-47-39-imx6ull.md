---
layout: post
author: '贾献华'
title: "Linux Lab 真板开发日志：野火 imx6ull 上手体验"
draft: true
tagline: "开发记录及野火开发板初体验"
# album: " 所属文章系列/专辑，如果有的话"
# group: " 默认为 original，也可选 translation, news, resume or jobs, 详见 _data/groups.yml"
license: "cc-by-nc-nd-4.0"
permalink: /imx6ull/
description: "开发过程记录请参考：<https://gitee.com/tinylab/linux-lab/issues/I28KSD>"
category:
  - Linux 开发
  - ARM
  - 开发板
  - 引导与启动
tags:
  - 真板
  - imx6ull
---

> By 贾献华 of [iosdevlog.com][1]
> Jan 12, 2021

## 2021年11月11日：项目开始

2020年11月11日 中午 *LinuxLab-吴章金* 在 **Linux Lab 用户交流群** 发布：

> 大家好，`v0.6` 计划开始支持真实的硬件开发板，可能会从这块板子开始，已经联系到知名板子设计厂商赞助开发板，欢迎感兴趣的同学报名。

于是我就兴冲冲的报名了，当天就拉了一个 **Linux Lab v0.6+ 真板群**。

自己要先熟悉一下 *arm/mcimx6ul-evk* 板子，后来邀请到 *imx6ul* 板子开发者 **吴平**，在开发过程中会抽空指导帮助。

初步目标：

1. 一键 `make boot` 真实板子（含其他功能兼容，`debug`，`test`，新增 `flash`）
2. 完善 `README.md`，整理各种资料信息
3. 撰写几篇相关文章（每个参与的同学至少一篇文章，不少于一个 `PR merge` 到项目，每人送一个板子）

**kalgan** 承当 *PM*。

2020年11月14日 确定真板：`imx6ull`。

![imx6ull](http://doc.embedfire.com/linux/imx6/base/zh/latest/_images/ebf6ul008.jpeg)

这套 `linux` 板子相关的资料：<https://ebf-products.readthedocs.io/zh_CN/latest/linux/ebf_i.mx6ull.html>。

下图是我总结相关思维导图。

![linux](/wp-content/uploads/2021/01/imx6ull/linux.png)

2020年12月8日 邀请板子的赞助商野火电子的杨总 **杨森** 及几位野火电子的同学们。

Linux Lab 的目标是 **one command for everything ;-)**。

后面的项目计划可以更新到这里，刚创建了一笔 issue：<https://gitee.com/tinylab/linux-lab/issues/I28KSD>。

2020年12月17日 确定真板数量：5 个大板子和 1 个小板子。

2020年12月19日 周六，协调开发计划的会议临时取消。

2020年12月23日 收到开发板, 是大板子，还带了触摸屏。

![imx6ull pro](/wp-content/uploads/2021/01/imx6ull/imx6ull_pro.png)

2020年12月28日 下午 12:05 *LinuxLab-吴章金* 在 **泰晓原创团队0群** 发布：

> Linux Lab 第一块真实硬件开发板的基础开发工作基本 Ready，争取这两天在 v0.6-rc2 发布，欢迎同学们关注。
>
> 开发过程记录请参考：<https://gitee.com/tinylab/linux-lab/issues/I28KSD>
>
> 大家有需要使用这块开发板的话，咱们可以组织一批团购，欢迎私信@晓泰 报名哈。

2021年1月4日 [Linux Lab 发布 v0.6-rc2，新增首块真实硬件开发板](http://tinylab.org/linux-lab-v06-rc2/)。

## 2020年12月24日：真板体验

### 用户

```bash
# root
username: root
password: root

# normal
username: debian
password: temppwd
```

### 串口

[2. 运行开发板与串口终端登录 - [野火]i.MX Linux开发实战指南 文档](http://doc.embedfire.com/linux/imx6/base/zh/latest/linux_basis/board_startup.html)

### SSH

```bash
ifconfig | grep 192
# inet 192.168.1.146  netmask 255.255.255.0  broadcast 192.168.1.255
#        inet 192.168.7.2  netmask 255.255.255.252  broadcast 192.168.7.3
#        TX packets 904  bytes 197373 (192.7 KiB)
fire-config # enable ssh
sudo apt install  avahi-daemon # npi hostname
```

### 登录客户端

Windows:

[MobaXterm SSH](https://mobaxterm.mobatek.net/download-home-edition.html)

![MobaXterm](/wp-content/uploads/2021/01/imx6ull/MobaXterm.png)

Linux & macOS:

```bash
# ip address
ssh debian@192.168.0.xxx
# npi hostname
ssh debian@npi
```

### 刷 “预览版” 镜像

[9. 烧录Debian镜像至SD卡 - [野火]i.MX Linux开发实战指南 文档](/wp-content/uploads/2021/01/imx6ull/http://doc.embedfire.com/linux/imx6/base/zh/latest/install_image/install_debian_to_sd.html#debiansd)

选择 “预览版”。

SD 卡启动后有一个 Linux Logo。

![preview](/wp-content/uploads/2021/01/imx6ull/preview.jpg)

usb 口能虚拟个 U盘、串口、网卡出来。

![usb](/wp-content/uploads/2021/01/imx6ull/usb.png)

把 `boot` 分区做成 U盘 方便修改，特别是 *uEnv.txt* 文件，我们用它加载设备树。

#### macOS U盘:

![macOS_boot](/wp-content/uploads/2021/01/imx6ull/macOS_boot.png)

#### Windows 10:

![windows10_boot_1](/wp-content/uploads/2021/01/imx6ull/windows10_boot_1.png)

![windows10_boot_2](/wp-content/uploads/2021/01/imx6ull/windows10_boot_2.png)

#### 网卡禁用数字签名

[http://www.win10xiazai.com/win10/8148.html](http://www.win10xiazai.com/win10/8148.html)

网卡驱动：[RNDIS.rar](/wp-content/uploads/2021/01/imx6ull/RNDIS.rar)

多出一个 Linux USB Ethernet。

![windows10_ethernet](/wp-content/uploads/2021/01/imx6ull/windows10_ethernet.png)

`Window + R` 打开设备管理器。

```bash
devmgmt.msc
```

![devmgmt](/wp-content/uploads/2021/01/imx6ull/devmgmt.png)

### 烧录到 emmc

```bash
sudo fire-config
```

选择 *7 Advanced*。

![7_Advanced](/wp-content/uploads/2021/01/imx6ull/7_Advanced.png)

选择 *A2 Flasher*。

![A2_Flasher](/wp-content/uploads/2021/01/imx6ull/A2_Flasher.png)

同意 Enabled?

![enable](/wp-content/uploads/2021/01/imx6ull/enable.png)

同意后 Enabled!

![enabled](/wp-content/uploads/2021/01/imx6ull/enabled.png)

重启 Reboot

![reboot](/wp-content/uploads/2021/01/imx6ull/reboot.png)

## 2021年12月24日：熟悉 EBF_6ULL 开发板

### LED

```bash
#为方便使用echo命令修改系统文件，提升至root权限进行操作
#执行该命令后，再执行exit可退回普通用户
sudo -s

#在root权限下进行下列操作
#LED灯默认可能处于亮的状态，我们先把它们全部关闭再一盏盏点亮
echo 0 > /sys/class/leds/red/brightness      #关闭red灯
echo 0 > /sys/class/leds/blue/brightness     #关闭blue灯
echo 0 > /sys/class/leds/green/brightness    #关闭green灯
echo 255 > /sys/class/leds/red/brightness    #点亮red灯
echo 255 > /sys/class/leds/blue/brightness   #点亮blue灯
echo 255 > /sys/class/leds/green/brightness  #点亮green灯
```

脚本测试硬件。

```bash
sudo apt update
sudo apt install peripheral
cd ~/peripheral
./led.sh
```

### gcc & hello world

*hello.c*

```bash
#include <stdio.h>

int main(int argc, char *argv[]) {
	printf("Hello World!\n");
	return 0;
}
```

`make`

```bash
sudo apt install gcc make -y
gcc -v
# Using built-in specs.
# COLLECT_GCC=gcc
# COLLECT_LTO_WRAPPER=/usr/lib/gcc/arm-linux-gnueabihf/8/lto-wrapper
# Target: arm-linux-gnueabihf
make hello
# cc     hello.c   -o hello
./hello
# Hello World!
```

`readelf -h hello`

```bash
ELF Header:
  Magic:   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00
  Class:                             ELF32
  Data:                              2's complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0
  Type:                              DYN (Shared object file)
  Machine:                           ARM
  Version:                           0x1
  Entry point address:               0x3fd
  Start of program headers:          52 (bytes into file)
  Start of section headers:          6976 (bytes into file)
  Flags:                             0x5000400, Version5 EABI, hard-float ABI
  Size of this header:               52 (bytes)
  Size of program headers:           32 (bytes)
  Number of program headers:         9
  Size of section headers:           40 (bytes)
  Number of section headers:         29
  Section header string table index: 28
```

## 2021年12月25日：编译 qemu-arm-mcimx6ul-evk

注意：

> 这里只是记录了当时的开发过程，其中有些操作是不必要，甚至是错误的，请以官方最新版为准备为准。

2020年12月25日

开发环境： Ubuntu 18.04 VirtualBox

### 运行 qemu-arm-mcimx6ul-evk

```bash
git clone https://gitee.com/tinylab/qemu-arm-mcimx6ul-evk
cd qemu-arm-mcimx6ul-evk/
sudo apt install make gcc-arm-linux-gnueabihf gcc bison flex libssl-dev dpkg-dev lzop
sudo apt install libsdl2-image-dev -y
sudo vim /etc/apt/sources.list
# deb http://cz.archive.ubuntu.com/ubuntu xenial main
sudo apt update
sudo apt install libpng12-0 -y
```

`./boot.sh`

```bash
linux-lab login: root
[   36.390412] usb_otg1_vbus: disabling
# uname -a
Linux linux-lab 5.4.0-dirty #1 SMP Wed Apr 8 23:55:27 CST 2020 armv7l GNU/Linux
# poweroff
```

### 编译内核

[https://github.com/Embedfire/ebf_linux_kernel](https://github.com/Embedfire/ebf_linux_kernel)

开发环境：Linux Lab Ubuntu 20.04 (macOS Big Sur 11.1)

[泰晓科技/Linux Lab](https://gitee.com/tinylab/linux-lab)

```bash
sudo useradd --create-home --shell /bin/bash --user-group --groups adm,sudo iosdevlog
sudo passwd iosdevlog
sudo -su iosdevlog
whoami
# iosdevlog
```

### 下载 LinuxLab

```bash
git clone https://gitee.com/tinylab/cloud-lab.git
cd cloud-lab/ && tools/docker/choose linux-lab
```

### 运行 LinuxLab

```bash
tools/docker/run linux-lab
tools/docker/bash
```

### IMX6ULL + 野火 Patch

```bash
make list | grep imx6ul
# [ arm/mcimx6ul-evk ]:
make BOARD=mcimx6ul-evk
make boot
```

### LinuxLab 开发 Linux (真板还不支持以下操作)

```bash
make kernel-download
make kernel-checkout
make kernel-patch
make kernel-defconfig
make kernel-menuconfig
make kernel
make boot
```

### Linux Kernel 手动编译

链接: [https://pan.baidu.com/s/1AZHdBMnB63zLbZjbsa73xg](https://pan.baidu.com/s/1AZHdBMnB63zLbZjbsa73xg)  密码: csnu

```bash
# 下载 Linux 源码
make kernel-download
cd /labs/linux-lab/src/patch/linux
# 解压patch补丁
tar xzvf ebf_6ull_patch.v4.19.35.tar.gz
ls v4.19.35 | wc
#    5194    5194  321387
# 进入 linux stable 内核目录
cd /labs/linux-lab/src/linux-stable
# 检出 linux stable 4.19.35 标签
git checkout v4.19.35
# 打补丁
git am /labs/linux-lab/src/patch/linux/v4.19.35/*.patch
# Applying: MLK-11265-10 ARM: configs: add imx v7 support
# Applying: MLK-11265-1 ARM: dts: add imx7d soc dtsi support
# ...
# 基本 1 秒 1 个补丁，可能要等 1 个多小时
```

![patch](/wp-content/uploads/2021/01/imx6ull/patch.png)

2 个 多小时后终于好了（这个可能自己 MacBook Pro 的原因）。

![PatchEnd](/wp-content/uploads/2021/01/imx6ull/PatchEnd.png)

添加 `sdma-imx6q.bin`。

```bash
cp sdma-imx6q.bin firmware/sdma-imx6q.bin
git add -f .
git commit -m "sdma-imx6q.bin"
```

![sdma-imx6q.bin](/wp-content/uploads/2021/01/imx6ull/sdma-imx6q.bin.png)

编译内核前建议先安装以下工具。

```bash
sudo apt install make gcc-arm-linux-gnueabihf gcc bison flex libssl-dev dpkg-dev lzop
# 报错，编辑 /etc/apt/sources.list
sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak
sudo vi /etc/apt/sources.list
```

野火提供 Ubuntu 18.04，这里是 Ubuntu 20.04，换一下官方源。

```bash
# See http://help.ubuntu.com/community/UpgradeNotes for how to upgrade to
# newer versions of the distribution.
deb http://archive.ubuntu.com/ubuntu focal main restricted
# deb-src http://archive.ubuntu.com/ubuntu focal main restricted

## Major bug fix updates produced after the final release of the
## distribution.
deb http://archive.ubuntu.com/ubuntu focal-updates main restricted
# deb-src http://archive.ubuntu.com/ubuntu focal-updates main restricted

## N.B. software from this repository is ENTIRELY UNSUPPORTED by the Ubuntu
## team. Also, please note that software in universe WILL NOT receive any
## review or updates from the Ubuntu security team.
deb http://archive.ubuntu.com/ubuntu focal universe
# deb-src http://archive.ubuntu.com/ubuntu focal universe
deb http://archive.ubuntu.com/ubuntu focal-updates universe
# deb-src http://archive.ubuntu.com/ubuntu focal-updates universe

## N.B. software from this repository is ENTIRELY UNSUPPORTED by the Ubuntu
## team, and may not be under a free licence. Please satisfy yourself as to
## your rights to use the software. Also, please note that software in
## multiverse WILL NOT receive any review or updates from the Ubuntu
## security team.
deb http://archive.ubuntu.com/ubuntu focal multiverse
# deb-src http://archive.ubuntu.com/ubuntu focal multiverse
deb http://archive.ubuntu.com/ubuntu focal-updates multiverse
# deb-src http://archive.ubuntu.com/ubuntu focal-updates multiverse

## N.B. software from this repository may not have been tested as
## extensively as that contained in the main release, although it includes
## newer versions of some applications which may provide useful features.
## Also, please note that software in backports WILL NOT receive any review
## or updates from the Ubuntu security team.
deb http://archive.ubuntu.com/ubuntu focal-backports main restricted universe multiverse
# deb-src http://archive.ubuntu.com/ubuntu focal-backports main restricted universe multiverse

## Uncomment the following two lines to add software from Canonical's
## 'partner' repository.
## This software is not part of Ubuntu, but is offered by Canonical and the
## respective vendors as a service to Ubuntu users.
# deb http://archive.canonical.com/ubuntu focal partner
# deb-src http://archive.canonical.com/ubuntu focal partner

deb http://archive.ubuntu.com/ubuntu focal-security main restricted
# deb-src http://archive.ubuntu.com/ubuntu focal-security main restricted
deb http://archive.ubuntu.com/ubuntu focal-security universe
# deb-src http://archive.ubuntu.com/ubuntu focal-security universe
deb http://archive.ubuntu.com/ubuntu focal-security multiverse
# deb-src http://archive.ubuntu.com/ubuntu focal-security multiverse
```

### 更新源

```bash
sudo apt update
sudo apt --fix-broken install
sudo apt install make gcc-arm-linux-gnueabihf gcc bison flex libssl-dev dpkg-dev lzop
```

### arm-linux-gnueabihf-gcc 9.3.0

```bash
$ arm-linux-gnueabihf-gcc -v
Using built-in specs.
COLLECT_GCC=arm-linux-gnueabihf-gcc
COLLECT_LTO_WRAPPER=/usr/lib/gcc-cross/arm-linux-gnueabihf/9/lto-wrapper
Target: arm-linux-gnueabihf
Configured with: ../src/configure -v --with-pkgversion='Ubuntu 9.3.0-17ubuntu1~20.04' --with-bugurl=file:///usr/share/doc/gcc-9/README.Bugs --enable-languages=c,ada,c++,go,d,fortran,objc,obj-c++,gm2 --prefix=/usr --with-gcc-major-version-only --program-suffix=-9 --enable-shared --enable-linker-build-id --libexecdir=/usr/lib --without-included-gettext --enable-threads=posix --libdir=/usr/lib --enable-nls --with-sysroot=/ --enable-clocale=gnu --enable-libstdcxx-debug --enable-libstdcxx-time=yes --with-default-libstdcxx-abi=new --enable-gnu-unique-object --disable-libitm --disable-libquadmath --disable-libquadmath-support --enable-plugin --enable-default-pie --with-system-zlib --without-target-system-zlib --enable-libpth-m2 --enable-multiarch --enable-multilib --disable-sjlj-exceptions --with-arch=armv7-a --with-fpu=vfpv3-d16 --with-float=hard --with-mode=thumb --disable-werror --enable-multilib --enable-checking=release --build=x86_64-linux-gnu --host=x86_64-linux-gnu --target=arm-linux-gnueabihf --program-prefix=arm-linux-gnueabihf- --includedir=/usr/arm-linux-gnueabihf/include
Thread model: posix
gcc version 9.3.0 (Ubuntu 9.3.0-17ubuntu1~20.04)
```

一键编译内核 deb 包。

```bash
./make_deb.sh
...
make[6]: *** [/labs/linux-lab/src/linux-stable/Makefile:1052: drivers] Error 2
make[5]: *** [Makefile:146: sub-make] Error 2
make[4]: *** [Makefile:24: __sub-make] Error 2
make[3]: *** [debian/rules:4: build] Error 2
dpkg-buildpackage: error: debian/rules build subprocess returned exit status 2
make[2]: *** [/labs/linux-lab/src/linux-stable/scripts/package/Makefile:80: bindeb-pkg] Error 2
make[1]: *** [/labs/linux-lab/src/linux-stable/Makefile:1365: bindeb-pkg] Error 2
make[1]: Leaving directory '/labs/linux-lab/src/linux-stable/build_image/build'
make: *** [Makefile:146: sub-make] Error 2
```

失败了，明天再看（在 Ubuntu 18.04 上按照野火文档是可以正常编译的）。

![error](/wp-content/uploads/2021/01/imx6ull/error.png)

### 升级 deb

[4. 构建野火Debian系统固件 - [野火]i.MX Linux开发实战指南 文档](http://doc.embedfire.com/linux/imx6/base/zh/latest/building_image/building_debian.html)

[update-fire-kernel.sh](http://update-fire-kernel.sh/)

```bash
#!/bin/sh -e

_do () {
         $@ || ( cp -rf /tmp/boot /; echo "kernel update failed: $@"; exit -1; )
}

if [ ! -f /boot/vmlinuz* ]; then
        echo "error:fire kernel no exit!"
else
        cp -rf /boot /tmp

   _do dpkg -r linux-image-$(uname -r)

        _do dpkg -i $1

        if [ -f /boot/vmlinuz* ]; then
                rm -rf /tmp/boot
        else
                cp -rf /tmp/boot /
        fi
fi
```

### 执行升级操作

```bash
chmod +x ./update-fire-kernel.sh
sudo ./update-fire-kernel.sh ./linux-image-4.19.71-imx-r1_1stable_armhf.deb
```

## 2020年12月26日： arm/ebf-imx6ul

目前是开发的初始阶段，文档也时刻在变，这里只记录部分开发测试过程，请以最新文档主准。

### 启动 LinuxLab

```bash
cd ~/Documents/labspace/cloud-lab
tools/docker/update linux-lab
tools/docker/bash
```

### 进入 LinuxLab

```bash
git branch -vv
# * master 13e7c8f [origin/master] Linux Lab v0.6-rc1
git pull
git checkout ebf
```

### 查看文档

[泰晓科技/Linux Lab EmbedFire i.MX6UL/ULL-EVK-PRO Board](https://gitee.com/tinylab/linux-lab/tree/ebf/boards/arm/ebf-imx6ul)

使用 mmc。

```bash
sed -i -e "s/imx6ul-nand-npi.dtb/imx6ul-mmc-npi.dtb/g" boards/arm/ebf-imx6ul/Makefile
```

### 编译

```bash
make BOARD=arm/ebf-imx6ul
make kernel
```

macOS 系统下 patch 有点问题，用 Ubuntu 18.04 试试。

后来把把 `cloud-lab` 删除重来，又正常了，可能是我昨天改错东西了。

![macOS](/wp-content/uploads/2021/01/imx6ull/macOS.png)

```bash
make kernel-save
make modules-install

ls boards/arm/ebf-imx6ul/bsp/kernel/v4.19.35/
# imx6ull-nand-npi.dtb  zImage
$ ls boards/arm/ebf-imx6ul/bsp/root/2020.02/rootfs/lib/modules/
# 4.19.35+
rm boards/arm/ebf-imx6ul/bsp/root/2020.02/rootfs/lib/modules/4.19.35+/{source,build}
```

### 上传 zImage & dtb

我是在远程编译的，要先 `scp` 到本地，再从本地 `scp` 到 **开发板**。

如果使用 *MobaXterm* 是可以直接拖放的。

最好备份一下。

### PC

```bash
scp boards/arm/ebf-imx6ul/bsp/kernel/v4.19.35/zImage debian@192.168.1.128:~/
scp boards/arm/ebf-imx6ul/bsp/kernel/v4.19.35/imx6ull-mmc-npi.dtb debian@192.168.1.128:~/
scp -r boards/arm/ebf-imx6ul/bsp/root/2020.02/rootfs/lib/modules/4.19.35+ debian@192.168.1.128:~/
```

### Board

```bash
sudo mkdir -p /boot/dtbs/4.19.35+
sudo mv ~/imx6ull-nand-npi.dtb /boot/dtbs/4.19.35+/
sudo mv ~/zImage /boot/vmlinuz-4.19.35+

sudo mv ~/4.19.35+ /lib/modules/
sudo update-initramfs -u -k 4.19.35+
```

### Boot 新 Image

`mmc` 和 `sd` 都是用的 `imx6ull-mmc-npi.dtb`。

```bash
$ sudo sed -i -e "s/uname_r=.*/uname_r=4.19.35+/g" /boot/uEnv.txt
$ sudo sed -i -e "s/dtb=.*/dtb=imx6ull-mmc-npi.dtb/g" /boot/uEnv.txt
$ sudo reboot
```

### Boot 拨码开关

* mmc: `2-4-5-7`
* sd: `2-5-8`

![macOS](/wp-content/uploads/2021/01/imx6ull/ebf.png)

版本改成：`4.19.35+`，时间改成 `2020/12/26`，说明 Linux Lab 下是可以进行真板开发的。


![sd_error](/wp-content/uploads/2021/01/imx6ull/sd_error.jpg)

`dtoverlays` 的路径要改一下，下周再试吧。

![sd](/wp-content/uploads/2021/01/imx6ull/sd.png)

我的拔码开发 8 坏了，emmc 启动的状态下，如果有 sd 卡，还是会从 sd 卡启动。

后续可以自动更新到 **开发板** 上，不需要现在这样麻烦，期待中...

## 2020年12月30日：arm/ebf-imx6ull

目前是开发的初始阶段，文档也时刻在变，这里只记录部分开发测试过程，请以最新文档主准。

昨天是 **ebf-imx6ul**，今天统一了一下，多加了一个 `l`。

### [按文档操作](https://gitee.com/tinylab/linux-lab/issues/I28KSD)

```sh
git checkout ebf
git pull
sed -i -e "s/nand/mmc/g" boards/arm/ebf-imx6ull/Makefile
make BOARD=arm/ebf-imx6ull
make kernel-build
```

### 使用 COM 串口

```bash
root@npi:~# passwd
New password:
Retype new password:
passwd: Authentication token manipulation error
passwd: password unchanged
```

[Getting an "Authentication token manipulation" error when trying to change my user password](/wp-content/uploads/2021/01/imx6ull/https://askubuntu.com/questions/57620/getting-an-authentication-token-manipulation-error-when-trying-to-change-my-us)

```bash
root@npi:/home/debian# pwconv
pwconv: /etc/passwd.843: No space left on device
pwconv: cannot lock /etc/passwd; try again later.
```

### 看看空间

```bash
root@npi:/home/debian# df -h
Filesystem      Size  Used Avail Use% Mounted on
udev             82M     0   82M   0% /dev
tmpfs            50M  5.3M   44M  11% /run
/dev/mmcblk1p2  6.5G  6.5G     0 100% /
tmpfs           246M     0  246M   0% /dev/shm
tmpfs           5.0M     0  5.0M   0% /run/lock
tmpfs           246M     0  246M   0% /sys/fs/cgroup
tmpfs            40K     0   40K   0% /mnt/.psplash
tmpfs            50M     0   50M   0% /run/user/0
tmpfs            50M     0   50M   0% /run/user/1000
```

![space](/wp-content/uploads/2021/01/imx6ull/space.png)

应该是没有空间了，删除一些文件。

```bash
rm -rf /home/debian/qt-app-static/video/
root@npi:~# sed -i -e "s/#PermitRootLogin prohibit-password/PermitRootLogin yes/g" /etc/ssh/sshd_config
root@npi:~#
```

改完密码后，macOS 和 windows 10 下的 Docker 都找不到 `/dev/ttyUSB0` 串口。

`make boot` 失败。

```
ubuntu@linux-lab:/labs/linux-lab$ make boot
Makefile:49: WARN: Lab should **NOT** belong to 'root', please change their owne
r in host: 'sudo chown $USER:$USER -R /path/to/cloud-lab/{*,.git}'
Makefile:50: WARN: Cancel this warning via: 'export WARN_ON_USER=0'
minicom -D /dev/ttyUSB0 -b 115200
minicom: cannot open /dev/ttyUSB0: No such file or directory
make: *** [Makefile:3651: _boot] Error 1
```

Windows 10 串口 应该是 **COM[0-9*]**，macOS 下可能是 `/dev/tty.usbserial-144410`。

但是 Docker 下不知道怎么找了。

我们切换到 VirtualBox。

### Windows 10 下使用 VirtualBox

![virtualbox](/wp-content/uploads/2021/01/imx6ull/virtualbox.jpg)

上传 zImage， dtb， modules。

```bash
make kernel-upload
make dtb-upload
make modules-upload
```

新 Image 启动。

```bash
make boot
```

![run](/wp-content/uploads/2021/01/imx6ull/run.jpg)

@吴章金 @杨森 Windows 10 下，VituralBox Ubuntu ，终于可以了。

可能是我删除了 Qt 下面的一些东西，启动后画面不动了。

![GUI](/wp-content/uploads/2021/01/imx6ull/GUI.jpg)

触摸屏也不能工作，使用 `evtest` 测试一下。

```bash
sudo apt install evtest
sudo evtest
```

好像没有反应。

![evtest](/wp-content/uploads/2021/01/imx6ull/evtest.jpg)

```
No device specified, trying to scan all of /dev/input/event*
Available devices:
/dev/input/event0:	20cc000.snvs:snvs-powerkey
/dev/input/event1:	gpio-keys
Select the device event number [0-1]:
```

看下触摸屏内核模块有没有自动加载 `lsmod`。

![lsmod](/wp-content/uploads/2021/01/imx6ull/lsmod.jpg)

看下驱动 log: `dmesg|grep Goodix`。

```bash
debian@npi:~$ dmesg|grep Goodix
[   19.968983] Goodix-TS 0-005d: i2c test failed attempt 1: -6
[   20.066545] Goodix-TS 0-005d: i2c test failed attempt 2: -6
[   20.159219] Goodix-TS 0-005d: I2C communication failure: -6
```

![Goodix](/wp-content/uploads/2021/01/imx6ull/Goodix.jpg)

新的 Qt app 还在处理一些 bug，到时直接装就行了。

最新版已经可以使用 `evtest` 测试触摸屏了。

### 试试 macOS

macOS Docker 找不到串口，试着改了一下 `.labinit`，还是不行，估计要用 `ssh` 连接了。

```bash
ubuntu@linux-lab:/labs/linux-lab$ vi .labinit
ubuntu@linux-lab:/labs/linux-lab$ make boot
minicom -D /dev/cu.usbserial-144410 -b 115200
minicom: cannot open /dev/cu.usbserial-144410: No such file or directory
make: *** [Makefile:3651: _boot] Error 1
ubuntu@linux-lab:/labs/linux-lab$ ls /dev/cu.usbserial-144410
ls: cannot access '/dev/cu.usbserial-144410': No such file or directory
ubuntu@linux-lab:/labs/linux-lab$
```

切换到 `next` 分支。

```bash
git checkout next
git pull
```

试试 login。

```bash
ubuntu@linux-lab:/labs/linux-lab$ make login
LOG: Login via ssh protocol
/bin/sh: 1: sshpass: not found
make: *** [Makefile:3678: _boot] Error 127
```

下面是一些无用功。

```bash
# http://forum.ubuntu.org.cn/viewtopic.php?f=80&t=372236

sudo apt-get clean
cd /var/lib/apt
sudo mv lists lists.old
sudo mkdir -p lists/partial
sudo apt-get clean
sudo apt-get update

make packages-install
```

提示没有安装 `sshpass`，改了大半天，还是觉得是网络的问题，最后用连接 `iPhone` 热点，就能正常了。

所以要尽量保证环境一致：Docker 就是你。

`make boot` 成功过一次，board 重新启动后就卡住不动了。

后来就一直连接不上，可能还是网络问题。

```bash
ubuntu@linux-lab:/labs/linux-lab$ make boot
LOG: Configure new kernel and dtbs images
LOG: Rebooting via ssh
Connection to 192.168.1.132 closed by remote host.
LOG: Login via ssh protocol
make: *** [Makefile:3678: _boot] Error 255
```

![login](/wp-content/uploads/2021/01/imx6ull/login.png)

### 小结

一句话，为了少折腾，还是 Windows -> VirtualBox -> Ubuntu -> LinuxLab。

## 2020年12月30日：内核构建

### 切换到 ebf-imx6ull

```bash
make BOARD=arm/ebf-imx6ull
git branch
# * next
. tools/helper/complete.sh
make [TAB]
```

### 修改内核

进入内核源码目录，做一些修改。

```bash
vi src/linux-stable/init/main.c
```

`kernel_init` 添加添加一条打印。

ubuntu@linux-lab:/labs/linux-lab/src/linux-stable$ `git diff init/main.c`

```diff
diff --git a/init/main.c b/init/main.c
index e083fac08aed..c8041fa17d6c 100644
--- a/init/main.c
+++ b/init/main.c
@@ -1078,6 +1078,8 @@ static int __ref kernel_init(void *unused)

 	rcu_end_inkernel_boot();

+	printk(KERN_DEBUG "Hello, IMX6ULL from Linux Lab.");
+
 	if (ramdisk_execute_command) {
 		ret = run_init_process(ramdisk_execute_command);
 		if (!ret)
```

#### 编译安装

```bash
$ make kernel-build
$ make modules-install
```

#### 上传

```bash
make kernel-upload
```

#### 启动新 Image

```bash
make boot
```

#### 查看启动日志

```bash
debian@npi:~$ dmesg | grep from
[    0.000000] random: get_random_bytes called from start_kernel+0xa0/0x434 wi0
[    0.000000] rcu:     RCU restricting CPUs from NR_CPUS=4 to nr_cpu_ids=1.
[    1.543896] sii902x bound to mxs-lcdif from 21c8000.lcdif
[    1.646126] Console IMX rounded baud rate from 114943 to 114900
[    7.438844] Hello, IMX6ULL from Linux Lab.
[    9.745109] fec 20b4000.ethernet eth2: renamed from eth0
[   15.209116] systemd-journald[206]: Received request to flush runtime journa1
```

可以看到我们在 `init/main.c` 里添加的打印已经生效了。

![kernel](/wp-content/uploads/2021/01/imx6ull/kernel.png)

#### 查看一下内核信息：

```bash
debian@npi:~$ uname -a
Linux npi 4.19.35+ #2 SMP PREEMPT Wed Dec 30 17:33:39 CST 2020 armv7l GNU/Linux
```

是刚才编译的，说明我们修改的内核确实起作用了。

### 调试 Linux 内核

#### 虚拟开发板内核自动化调试

```bash
make feature feature=debug
make kernel-olddefconfig
make kernel
make kernel-debug
```

使用 WebVNC， 会自动打开两个窗口，一个显示原有内核，如果使用 bash，需要打开 2 个终端，一个做服务端，一个为客户端，详情请查阅文档。

默认设置了一些断点，可以通过以下命令查看：

```bash
cat ./gdb/kernel.default
```

自己随便玩。

* r: run 运行到断点
* n: next 到下一条语句
* s: step 单步执行
* b: breakpoint 下断点
* l: list 查看源码

#### 真板启动调试

```bash
$ make kernel-debug
LOG: This feature is not implemented for real boards.
```

> 真板还没加，这个不太好弄，可以试试 kgdb over serial。

### 小结

我还是先熟悉虚拟开发板的内核调试吧。

## 2020年12月31日：开发内核模块

请参考书籍：[《Linux 设备驱动程序》](https://www.oreilly.com/library/view/linux-device-drivers/0596005903/)。

### 撰写并运行内核模块

```bash
mkdir -p src/modules/hello_imx6ull
cd src/modules/hello_imx6ull
vi hello_imx6ull.c
```

`hello_imx6ull.c`

```c
#include <linux/kernel.h>
#include <linux/module.h>
#include <linux/init.h>

static int __init hello_imx6ull_init(void)
{
	pr_info("hello imx6ull module init\n");

	return 0;
}

static void __exit hello_imx6ull_exit(void)
{
	pr_info("hello imx6ull module exit\n");
}

module_init(hello_imx6ull_init);
module_exit(hello_imx6ull_exit);

MODULE_DESCRIPTION("hello imx6ull - Linux Lab real board module example");
MODULE_AUTHOR("iOSDevLog <iosdevlog@iosdevlog.com>");
MODULE_LICENSE("GPL");
```

`Makefile`

```make
# ARCH = arm
# CROSS_COMPILE = arm-linux-gnueabi-

KERNEL_SRC ?= /lib/modules/`uname -r`/build

obj-m	+=   hello_imx6ull.o


modules:
	$(MAKE) -C $(KERNEL_SRC) M=$$PWD modules;

modules-install:
	$(MAKE) -C $(KERNEL_SRC) M=$$PWD modules-install;

clean:
	$(MAKE) -C $(KERNEL_SRC) M=$$PWD clean;
	$(RM) *.ko;
```

### 编译该内核模块

```bash
make modules m=hello_imx6ull
make modules-install m=hello_imx6ull
make modules-upload
```

### 在真板上启动内核模块

```bash
make login
```

登录 IMX6ULL。

```bash
sudo modprobe hello_imx6ull
modprobe: ERROR: could not insert 'hello_imx6ull': Exec format error
```

原因未知。

### 2021年01年04日 重新执行

将 *预览版* 从 TF卡 [fire-config刷机](https://embed-linux-tutorial.readthedocs.io/zh_CN/latest/linux_basis/fire-config_brief.html) 到 emmc。

重新执行了一遍 `next` 分支的操作。

已经有了 `hello_imx6ull` 模块，这次新建一个 `hello_linux_lab_hello`。

```bash
cp -r src/modules/hello src/modules/hello_linux_lab_hello
cd src/modules/hello_linux_lab_hello
mv hello.c hello_linux_lab_hello.c
```

`hello_linux_lab_hello.c`

```c
#include <linux/kernel.h>
#include <linux/module.h>
#include <linux/init.h>

static int __init hello_linux_lab_imx6ull_init(void)
{
	pr_info("hello linux-lab imx6ull module init\n");

	return 0;
}

static void __exit hello_linux_lab_imx6ull_exit(void)
{
	pr_info("hello linux-lab imx6ull module exit\n");
}

module_init(hello_linux_lab_imx6ull_init);
module_exit(hello_linux_lab_imx6ull_exit);

MODULE_DESCRIPTION("hello linux-lab imx6ull - Linux Lab real board module example");
MODULE_AUTHOR("iOSDevLog <iosdevlog@iosdevlog.com>");
MODULE_LICENSE("GPL");
```

`Makeifle`

```make
KERNEL_SRC ?= /lib/modules/`uname -r`/build

obj-m	+=   hello_linux_lab_imx6ull.o


modules:
	$(MAKE) -C $(KERNEL_SRC) M=$$PWD modules;

modules-install:
	$(MAKE) -C $(KERNEL_SRC) M=$$PWD modules-install;

clean:
	$(MAKE) -C $(KERNEL_SRC) M=$$PWD clean;
	rm -f *.ko;
```

Compile a kernel module and upload it，编译上传。

```bash
make modules m=hello_linux_lab_imx6ull
make modules-install m=hello_linux_lab_imx6ull
make modules-upload
```

### 验证

```bash
make login
```

查看 `hello_linux_lab_imx6ull.ko` 类型。

```bash
debian@npi:~$ ls /lib/modules/4.19.35+/extra/
hello.ko  hello_imx6ull.ko  hello_linux_lab_imx6ull.ko
sudo apt install file
file /lib/modules/4.19.35+/extra/*
```

同 `hello.ko` 一样。

```bash
/lib/modules/4.19.35+/extra/hello.ko:                   ELF 32-bit LSB relocatable, ARM, EABI5 version 1 (SYSV), BuildID[sha1]=c669968dec7cfd12ff354756b21f4cb6653fc74b, with debug_info, not stripped
/lib/modules/4.19.35+/extra/hello_imx6ull.ko:           ELF 32-bit LSB relocatable, ARM, EABI5 version 1 (SYSV), BuildID[sha1]=70f2771a81593d78ef1aea082b7bbf1ab54d6e11, with debug_info, not stripped
/lib/modules/4.19.35+/extra/hello_linux_lab_imx6ull.ko: ELF 32-bit LSB relocatable, ARM, EABI5 version 1 (SYSV), BuildID[sha1]=a72a2e20aa70392320fdcef88bb7844ae38a7c2c, with debug_info, not stripped
```

查看 `hello_linux_lab_imx6ull` 信息。

```bash
debian@npi:~$ sudo modprobe hello_linux_lab_imx6ull
[ 1177.900660] hello linux-lab imx6ull module init
debian@npi:~$ lsmod | grep hello_linux_lab_imx6ull
hello_linux_lab_imx6ull    16384  0
debian@npi:~$ dmesg | grep "hello linux"
[ 1177.900660] hello linux-lab imx6ull module init
debian@npi:~$ modinfo hello_linux_lab_imx6ull
filename:       /lib/modules/4.19.35+/extra/hello_linux_lab_imx6ull.ko
license:        GPL
author:         iOSDevLog <iosdevlog@iosdevlog.com>
description:    hello linux-lab imx6ull - Linux Lab real board module example
srcversion:     23F6F2563D3621635B131C2
depends:
name:           hello_linux_lab_imx6ull
vermagic:       4.19.35+ SMP preempt mod_unload modversions ARMv7 p2v8
```

![hello_linux_lab_imx6ull](/wp-content/uploads/2021/01/imx6ull/hello_linux_lab_imx6ull.png)

### 小结

年前不知什么原因，导致 `Exec format error` 错误，今天用干净的环境重新执行一下又可以了。

确实要使用相同的环境（抽象出虚拟层）。

## 2021年01月06日： u-boot

参考 **吴平** 文档：[手动运行uboot-2020.10 + Linux5.10.0 方法及存在的问题：](https://gitee.com/tinylab/linux-lab/issues/I28KSD)

### Linux Host 下编译步骤

```bash
cd ~/Code
git clone git://git.busybox.net/buildroot
cd buildroot
make imx6ullevk_defconfig
make menuconfig
```

这里选择 kernel 和 Bootloader 版本如下，其他默认即可。

* kernel-> kernel version : 5.10
* Bootloader -> U-boot Version : 2020.10

我在这里操作错误，结果报错。

![kernel_error](/wp-content/uploads/2021/01/imx6ull/kernel_error.png)

![5.10](/wp-content/uploads/2021/01/imx6ull/5.10.png)

![uboot](/wp-content/uploads/2021/01/imx6ull/uboot.png)

```bash
make[1]: Leaving directory '/home/george/Code/buildroot/output/build/linux-headers-5.10'
if ! support/scripts/check-kernel-headers.sh  /home/george/Code/buildroot/output/build  /home/george/Code/buildroot/output/host/arm-buildroot-linux-uclibcgnueabihf/sysroot  5.7 strict; then exit 1; fi
Incorrect selection of kernel headers: expected 5.7.x, got 5.10.x
package/pkg-generic.mk:286: recipe for target '/home/george/Code/buildroot/output/build/linux-headers-5.10/.stamp_staging_installed' failed
make: *** [/home/george/Code/buildroot/output/build/linux-headers-5.10/.stamp_staging_installed] Error 1
```

查看 `.config`。

```bash
# BR2_PACKAGE_HOST_LINUX_HEADERS_CUSTOM_5_8 is not set
 BR2_PACKAGE_HOST_LINUX_HEADERS_CUSTOM_5_7=y
```

先把 kernel 和 Bootloader 的 version 选对。

![kernel5.10](/wp-content/uploads/2021/01/imx6ull/kernel5.10.png)

![kernel_menuconfig](/wp-content/uploads/2021/01/imx6ull/kernel_menuconfig.png)

在查找一下 5.7，按 `/` 查找。

![kernel_headers](/wp-content/uploads/2021/01/imx6ull/kernel_headers.png)

修改 `toolchain / Custom kernel headers seles (<choice> [-y])`

![custom_kernel_headers](/wp-content/uploads/2021/01/imx6ull/custom_kernel_headers.png)

make 成功后，查看一下生成文件，这里的 **sdcard.img** 就是我们要烧写的 SD卡的镜像。

![output](/wp-content/uploads/2021/01/imx6ull/output.png)

### 准备 SD卡 镜像(Linux PC 或虚拟机下)

![virtualbox_usb](/wp-content/uploads/2021/01/imx6ull/virtualbox_usb.png)

```bash
george@george-VirtualBox:~/Code/buildroot$ ls -al /dev/sd*
brw-rw---- 1 root disk 8,  0 1月   4 09:12 /dev/sda
brw-rw---- 1 root disk 8,  1 1月   4 09:12 /dev/sda1
brw-rw---- 1 root disk 8, 16 1月   6 14:44 /dev/sdb
brw-rw---- 1 root disk 8, 17 1月   6 14:44 /dev/sdb1
brw-rw---- 1 root disk 8, 18 1月   6 14:44 /dev/sdb2
```

多出一个 */dev/sdb*。

```bash
$ sudo dd if=output/images/sdcard.img of=/dev/sdb && sync
of=/dev/sdb && sync
[sudo] password for george:
172032+0 records in
172032+0 records out
88080384 bytes (88 MB, 84 MiB) copied, 259.832 s, 339 kB/s
```

### 将 SD（TF）卡插入板子的TF卡槽，连接串口线

### 打开串口终端并给开发板上电

### 在 u-boot console 下执行

```bash
=> fatload mmc 0 80800000 /zImage
=> run mmcboot
```

![uboot_error](/wp-content/uploads/2021/01/imx6ull/uboot_error.png)

```bash
=> setenv mmcdev 0
=> fatload mmc 0 80800000 /zImage
=> run mmcboot
```

![bad_img](/wp-content/uploads/2021/01/imx6ull/bad_img.png)

当前 SD 内容。

![sd_content](/wp-content/uploads/2021/01/imx6ull/sd_content.png)

**吴平** 文档里面的 Imgae: <https://pan.baidu.com/s/11lyhy1N-aG6pfhRwSq9-IQ> 提取码: `kmft`。

自己编的无法启动，咨询了 **吴平** ，又使用 **吴平**  提供的 Image 还是不能正常启动。

### 小结

自己对 U-boot 不熟悉，我还是先去看一下野火的文档吧。

## 总结

Linux Lab 新增首块真实硬件开发板 `arm/ebf-imx6ull` 支持，该开发板功能正在火热迭代中，可参考 [开发记录](https://gitee.com/tinylab/linux-lab/issues/I28KSD)。

目前还有一些功能等完善，期待更多的开发者前来体验。

[1]: https://www.iosdevlog.com

